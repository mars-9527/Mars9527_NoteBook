---
tags:
  - Doris
---

## 一、解压安装

```shell

# 创建安装目录
mkdir /opt/module
cd /opt/module
mkdir -p doris/doris-1.2.0

# 先用xz命令转化成tar包
xz -d *.xz
ll /mnt/hgfs/vmshare/doris/
-rwxrwxrwx 1 501 games 3094036480 1月   3 18:03 apache-doris-be-1.2.0-bin-x86_64.tar
-rwxrwxrwx 1 501 games  592189440 1月   3 18:02 apache-doris-fe-1.2.0-bin-x86_64.tar
-rwxrwxrwx 1 501 games  268267520 1月   3 18:02 apache-doris-java-udf-jar-with-dependencies-1.2.0-bin-x86_64.tar

# 此时再用tar文件的解压指令
cd doris/apache-doris-1.2.0

tar -xf /mnt/hgfs/vmshare/doris/apache-doris-fe-1.2.0-bin-x86_64.tar -C ./
mv apache-doris-fe-1.2.0-bin-x86_64 fe

tar -xf /mnt/hgfs/vmshare/doris/apache-doris-be-1.2.0-bin-x86_64.tar -C ./
mv apache-doris-be-1.2.0-bin-x86_64 be

tar -xf /mnt/hgfs/vmshare/doris/apache-doris-java-udf-jar-with-dependencies-1.2.0-bin-x86_64.tar -C be/lib/
cd be/lib/apache-doris-java-udf-jar-with-dependencies-1.2.0-bin-x86_64/
mv java-udf-jar-with-dependencies.jar ../
cd ..
rm -rf apache-doris-java-udf-jar-with-dependencies-1.2.0-bin-x86_64/


vi fe/conf/fe.conf

vim /etc/profile
```


## 二、 配置 Doris

### 配置 FE
我们进入到 `apache-doris-x.x.x/fe` 目录

```shell
cd doris/apache-doris-1.2.0
vi fe/conf/fe.conf
```

修改 FE 配置文件 `conf/fe.conf` ，这里我们主要修改两个参数：`priority_networks` 及 `meta_dir` ，如果你需要更多优化配置，请参考 [FE 参数配置](https://doris.apache.org/zh-CN/docs/dev/admin-manual/config/fe-config)说明，进行调整。

1.  添加 priority_networks 参数

```
priority_networks = 192.168.10.0/24
```

> 注意：
> 
> 这个参数我们在安装的时候是必须要配置的，特别是当一台机器拥有多个IP地址的时候，我们要为 FE 指定唯一的IP地址。

> 这里假设你的节点 IP 是 `172.23.16.32`，那么我们可以通过掩码的方式配置为 `172.23.16.0/24`。

1.  添加元数据目录

环境变量添加DORIS_HOME

```shell
vim /etc/profile
export DORIS_HOME=/opt/module/doris/doris-1.2.0
```

```
meta_dir = ${DORIS_HOME}/doris-meta
```

> 注意：
> 
> 这里你可以不配置，默认是在你的Doris FE 安装目录下的 doris-meta，
> 
> 单独配置元数据目录，需要你提前创建好你指定的目录

### 启动 FE
在 FE 安装目录下执行下面的命令，来完成 FE 的启动。

```
fe/bin/start_fe.sh --daemon
```

#### 查看 FE 运行状态

你可以通过下面的命令来检查 Doris 是否启动成功

```
curl http://127.0.0.1:8030/api/bootstrap
```

这里 IP 和 端口分别是 FE 的 IP 和 http_port（默认8030），如果是你在 FE 节点执行，直接运行上面的命令即可。

如果返回结果中带有 `"msg":"success"` 字样，则说明启动成功。

你也可以通过 Doris FE 提供的Web UI 来检查，在浏览器里输入地址

http:// fe_ip:8030
http://192.168.10.112:8030

可以看到下面的界面，说明 FE 启动成功
![[Pasted image 20230103210423.png | 1000]]

> 注意：
> 
> 1.  这里我们使用 Doris 内置的默认用户 root 进行登录，密码是空
> 2.  这是一个 Doris 的管理界面，只能拥有管理权限的用户才能登录，普通用户不能登录。
#### 连接 FE

我们下面通过 MySQL 客户端来连接 Doris FE，下载免安装的 [MySQL 客户端](https://doris-build-hk.oss-cn-hongkong.aliyuncs.com/mysql-client/mysql-5.7.22-linux-glibc2.12-x86_64.tar.gz)

解压刚才下载的 MySQL 客户端，在 `bin/` 目录下可以找到 `mysql` 命令行工具。然后执行下面的命令连接 Doris。

```
mysql -uroot -P9030 -h127.0.0.1
```

> 注意：
> 
> 1.  这里使用的 root 用户是 doris 内置的默认用户，也是超级管理员用户，具体的用户权限查看 [权限管理](https://doris.apache.org/zh-CN/docs/dev/admin-manual/privilege-ldap/user-privilege)
> 2.  -P ：这里是我们连接 Doris 的查询端口，默认端口是 9030，对应的是fe.conf里的 `query_port`
> 3.  -h ： 这里是我们连接的 FE IP地址，如果你的客户端和 FE 安装在同一个节点可以使用127.0.0.1，这种也是 Doris 提供的如果你忘记 root 密码，可以通过这种方式不需要密码直接连接登录，进行对 root 密码进行重置

执行下面的命令查看 FE 运行状态

```
show frontends\G;
```

然后你可以看到类似下面的结果：

```mysql
mysql> show frontends\G;
*************************** 1. row ***************************
             Name: 192.168.10.112_9010_1672750187339
               IP: 192.168.10.112
      EditLogPort: 9010
         HttpPort: 8030
        QueryPort: 9030
          RpcPort: 9020
             Role: FOLLOWER
         IsMaster: true
        ClusterId: 627058322
             Join: true
            Alive: true
ReplayedJournalId: 567
    LastHeartbeat: 2023-01-03 21:20:54
         IsHelper: true
           ErrMsg:
          Version: doris-1.2.0-rc04-Unknown
 CurrentConnected: Yes
1 row in set (0.01 sec)

ERROR:
No query specified

mysql>
```

如果 IsMaster、Join 和 Alive 三列均为true，则表示节点正常。

#### 停止 FE 节点
Doris FE 的停止可以通过下面的命令完成

```
fe/bin/stop_fe.sh
```

### 配置 BE
我们进入到 `apache-doris-x.x.x/be` 目录

```
cd apache-doris-x.x.x/be
```

修改 BE 配置文件 `conf/be.conf` ，这里我们主要修改两个参数：`priority_networks` 及 `storage_root` ，如果你需要更多优化配置，请参考 [BE 参数配置](https://doris.apache.org/zh-CN/docs/dev/admin-manual/config/be-config)说明，进行调整。

1.  添加 priority_networks 参数

```
priority_networks = 192.168.10.0/24
```

> 注意：
> 
> 这个参数我们在安装的时候是必须要配置的，特别是当一台机器拥有多个IP地址的时候，我们要为 BE 指定唯一的IP地址。

2.  配置 BE 数据存储目录

```
storage_root_path = ${DORIS_HOME}/data_dir
```

> 注意：
> 
> 1.  默认目录在 BE安装目录的 storage 目录下。
> 2.  BE 配置的存储目录必须先创建好

3.  配置 JAVA_HOME 环境变量

SinceVersion 1.2.0由于从 1.2 版本开始支持 Java UDF 函数，BE 依赖于 Java 环境。所以要预先配置 `JAVA_HOME` 环境变量，也可以在 `start_be.sh` 启动脚本第一行添加 `export JAVA_HOME=your_java_home_path` 来添加环境变量。

4.  安装 Java UDF 函数

SinceVersion 1.2.0安装Java UDF 函数因为从1.2 版本开始支持Java UDF 函数，需要从官网下载 Java UDF 函数的 JAR 包放到 BE 的 lib 目录下，否则可能会启动失败。

### 启动 BE

在 BE 安装目录下执行下面的命令，来完成 BE 的启动。

```
be/bin/start_be.sh --daemon
```


-   BE 启动脚本会通过 `/proc/sys/vm/max_map_count` 检查数值是否大于200W，否则启动失败。
临时修改
```shell
sysctl -w vm.max_map_count=2000000
```

永久修改
修改`/etc/sysctl.conf`

```vim
vm.max_map_count=2000000
```

#### 添加 BE 节点到集群
通过MySQL 客户端连接到 FE 之后执行下面的 SQL，将 BE 添加到集群中

```
ALTER SYSTEM ADD BACKEND "be_host_ip:heartbeat_service_port";

ALTER SYSTEM ADD BACKEND "192.168.10.112:9050";


alter system dropp backend '192.168.10.112:9050';

```

1.  be_host_ip：这里是你 BE 的 IP 地址，和你在 `be.conf` 里的 `priority_networks` 匹配
2.  heartbeat_service_port：这里是你 BE 的心跳上报端口，和你在 `be.conf` 里的 `heartbeat_service_port` 匹配，默认是 `9050`。

#### 查看 BE 运行状态

你可以在 MySQL 命令行下执行下面的命令查看 BE 的运行状态。

```
SHOW BACKENDS\G;
```

示例：

```mysql
mysql> SHOW BACKENDS\G;
Empty set (0.00 sec)

ERROR:
No query specified

mysql> ALTER SYSTEM ADD BACKEND "192.168.10.112:9050";
Query OK, 0 rows affected (0.04 sec)

mysql> SHOW BACKENDS\G;
*************************** 1. row ***************************
              BackendId: 11004
                Cluster: default_cluster
                     IP: 192.168.10.112
          HeartbeatPort: 9050
                 BePort: 9060
               HttpPort: 8040
               BrpcPort: 8060
          LastStartTime: 2023-01-03 23:41:48
          LastHeartbeat: 2023-01-03 23:43:10
                  Alive: true
   SystemDecommissioned: false
  ClusterDecommissioned: false
              TabletNum: 0
       DataUsedCapacity: 0.000
          AvailCapacity: 28.546 GB
          TotalCapacity: 39.247 GB
                UsedPct: 27.27 %
         MaxDiskUsedPct: 27.27 %
     RemoteUsedCapacity: 0.000
                    Tag: {"location" : "default"}
                 ErrMsg:
                Version: doris-1.2.0-rc04-Unknown
                 Status: {"lastSuccessReportTabletsTime":"2023-01-03 23:42:29","lastStreamLoadTime":-1,"isQueryDisabled":false,"isLoadDisabled":false}
HeartbeatFailureCounter: 0
               NodeRole: mix
1 row in set (0.01 sec)

ERROR:
No query specified

mysql>
```

1.  Alive : true表示节点运行正常

#### 停止 BE 节点
Doris BE 的停止可以通过下面的命令完成

```
be/bin/stop_be.sh
```


## 三、数据测试

### 创建数据表

1.  创建一个数据库

```
create database demo;
```

2.  创建数据表

```sql
use demo;

CREATE TABLE IF NOT EXISTS demo.example_tbl
(
    `user_id` LARGEINT NOT NULL COMMENT "用户id",
    `date` DATE NOT NULL COMMENT "数据灌入日期时间",
    `city` VARCHAR(20) COMMENT "用户所在城市",
    `age` SMALLINT COMMENT "用户年龄",
    `sex` TINYINT COMMENT "用户性别",
    `last_visit_date` DATETIME REPLACE DEFAULT "1970-01-01 00:00:00" COMMENT "用户最后一次访问时间",
    `cost` BIGINT SUM DEFAULT "0" COMMENT "用户总消费",
    `max_dwell_time` INT MAX DEFAULT "0" COMMENT "用户最大停留时间",
    `min_dwell_time` INT MIN DEFAULT "99999" COMMENT "用户最小停留时间"
)
AGGREGATE KEY(`user_id`, `date`, `city`, `age`, `sex`)
DISTRIBUTED BY HASH(`user_id`) BUCKETS 1
PROPERTIES (
    "replication_allocation" = "tag.location.default: 1"
);
```

3.  示例数据

```
10000,2017-10-01,北京,20,0,2017-10-01 06:00:00,20,10,10
10000,2017-10-01,北京,20,0,2017-10-01 07:00:00,15,2,2
10001,2017-10-01,北京,30,1,2017-10-01 17:05:45,2,22,22
10002,2017-10-02,上海,20,1,2017-10-02 12:59:12,200,5,5
10003,2017-10-02,广州,32,0,2017-10-02 11:20:00,30,11,11
10004,2017-10-01,深圳,35,0,2017-10-01 10:00:15,100,3,3
10004,2017-10-03,深圳,35,0,2017-10-03 10:20:22,11,6,6
```

将上面的数据保存在`test_data.csv`文件中。

1.  导入数据

```shell
curl  --location-trusted -u root: -T test_data.csv -H "column_separator:," http://127.0.0.1:8030/api/demo/example_tbl/_stream_load
```

-   -T test.csv : 这里使我们刚才保存的数据文件，如果路径不一样，请指定完整路径
-   -u root : 这里是用户名密码，我们使用默认用户root，密码是空
-   127.0.0.1:8030 : 分别是 fe 的 ip 和 http_port

执行成功之后我们可以看到下面的返回信息
```shell
[root@hadoop112 doris-1.2.0]# curl  --location-trusted -u root: -T test_data.csv -H "column_separator:," http://127.0.0.1:8030/api/demo/example_tbl/_stream_load
{
    "TxnId": 1,
    "Label": "531343ec-953a-4158-9651-7313865c4474",
    "TwoPhaseCommit": "false",
    "Status": "Success",
    "Message": "OK",
    "NumberTotalRows": 7,
    "NumberLoadedRows": 7,
    "NumberFilteredRows": 0,
    "NumberUnselectedRows": 0,
    "LoadBytes": 399,
    "LoadTimeMs": 130,
    "BeginTxnTimeMs": 21,
    "StreamLoadPutTimeMs": 63,
    "ReadDataTimeMs": 0,
    "WriteDataTimeMs": 10,
    "CommitAndPublishTimeMs": 33
}
[root@hadoop112 doris-1.2.0]#
```

1.  `NumberLoadedRows`: 表示已经导入的数据记录数
2.  `NumberTotalRows`: 表示要导入的总数据量
3.  `Status` :Success 表示导入成功
    
到这里我们已经完成的数据导入，下面就可以根据我们自己的需求对数据进行查询分析了。

### 查询数据

我们上面完成了建表，输数据导入，下面我们就可以体验 Doris 的数据快速查询分析能力。

```
mysql> select * from demo.example_tbl;
+---------+------------+--------+------+------+---------------------+------+----------------+----------------+
| user_id | date       | city   | age  | sex  | last_visit_date     | cost | max_dwell_time | min_dwell_time |
+---------+------------+--------+------+------+---------------------+------+----------------+----------------+
| 10000   | 2017-10-01 | 北京   |   20 |    0 | 2017-10-01 07:00:00 |   35 |             10 |              2 |
| 10001   | 2017-10-01 | 北京   |   30 |    1 | 2017-10-01 17:05:45 |    2 |             22 |             22 |
| 10002   | 2017-10-02 | 上海   |   20 |    1 | 2017-10-02 12:59:12 |  200 |              5 |              5 |
| 10003   | 2017-10-02 | 广州   |   32 |    0 | 2017-10-02 11:20:00 |   30 |             11 |             11 |
| 10004   | 2017-10-01 | 深圳   |   35 |    0 | 2017-10-01 10:00:15 |  100 |              3 |              3 |
| 10004   | 2017-10-03 | 深圳   |   35 |    0 | 2017-10-03 10:20:22 |   11 |              6 |              6 |
+---------+------------+--------+------+------+---------------------+------+----------------+----------------+
6 rows in set (0.07 sec)

mysql> select * from demo.example_tbl where city='上海';
+---------+------------+--------+------+------+---------------------+------+----------------+----------------+
| user_id | date       | city   | age  | sex  | last_visit_date     | cost | max_dwell_time | min_dwell_time |
+---------+------------+--------+------+------+---------------------+------+----------------+----------------+
| 10002   | 2017-10-02 | 上海   |   20 |    1 | 2017-10-02 12:59:12 |  200 |              5 |              5 |
+---------+------------+--------+------+------+---------------------+------+----------------+----------------+
1 row in set (0.04 sec)

mysql> select city, sum(cost) as total_cost from demo.example_tbl group by city;
+--------+------------+
| city   | total_cost |
+--------+------------+
| 北京   |         37 |
| 上海   |        200 |
| 广州   |         30 |
| 深圳   |        111 |
+--------+------------+
4 rows in set (0.05 sec)

mysql>
```

## 十、异常处理

### BE启动失败

日志报错一
```log
W0103 22:52:12.102566  3697 options.cpp:68] path can not be canonicalized. may be not exist. path=/opt/module/doris/doris-1.2.0/be/data_dir
W0103 22:52:12.108937  3697 options.cpp:147] failed to parse store path /opt/module/doris/doris-1.2.0/be/data_dir, res=Internal error(error -203):     @     0x5636880e4fb4  doris::Status::ConstructErrorStatus()
    @     0x5636880e5475  doris::Status::OLAPInternalError()
    @     0x563688291045  doris::parse_root_path()
    @     0x563688292d24  doris::parse_conf_store_paths()
    @     0x5636880d696f  main
    @     0x7f5ea107e555  __libc_start_main
    @     0x5636880c902a  _start
    @              (nil)  (unknown)
W0103 22:52:12.108947  3697 options.cpp:151] fail to parse storage_root_path config. value=[/opt/module/doris/doris-1.2.0/be/data_dir]
F0103 22:52:12.113763  3697 doris_main.cpp:345] parse config storage path failed, path=/opt/module/doris/doris-1.2.0/be/data_dir

```

解决
创建目录`/opt/module/doris/doris-1.2.0/be/data_dir`

日志报错二
```log
F0103 23:20:07.312326  5102 doris_main.cpp:408] fail to open StorageEngine, res=file descriptors limit is too small
*** Check failure stack trace: ***
    @     0x562001044d4d  google::LogMessage::Fail()
    @     0x562001047289  google::LogMessage::SendToLog()
    @     0x5620010448b6  google::LogMessage::Flush()
    @     0x5620010478f9  google::LogMessageFatal::~LogMessageFatal()
    @     0x561ffc8d49c2  main
    @     0x7f143e868555  __libc_start_main
    @     0x561ffc8c602a  _start
    @              (nil)  (unknown)
```

解决
在 `/etc/security/limits.conf` 中添加
```vim
* soft nofile 204800
* hard nofile 204800
* soft nproc 204800
* hard nproc 204800
```


