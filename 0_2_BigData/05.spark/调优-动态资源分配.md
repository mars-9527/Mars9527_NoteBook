# 一、动态资源分配机制

Spark提供了基于应用工作负载来动态分配资源的机制，这意味着应用可以根据需要想资源管理器（比如说YARN）释放资源和再请求资源。如果多个应用共享资源的话，这个特性是非常有用的。
需要首先说明的是，这套机制的基本单元是Executor，类似于其它产品中的Slot，这里的单个Executor的资源可通过 `spark.executor.memory` 和 `spark.executor.cores`分配配置其占用的内存及核数。

由于无法确切地知道什么时候需要请求Executor和移除Executor，Spark制定了一套请求和移除的机制。

-   请求机制。如果查看队列中有挂起的任务,且挂起的时间超过`spark.dynamicAllocation.schedulerBacklogTimeout` 秒，则请求Executor，按轮次请求，每轮按指数增加，如：1, 2, 4, 8 ……
-   移除机制。如果一个Executor空闲时间超过`spark.dynamicAllocation.executorIdleTimeout`秒，则移除。需要注意的是，在大多数场景下，这个与请求机制是互斥的，也就是说，如果还有挂起的任务，那就不应该释放资源。
    满足移除机制，还有两个细节需要处理才能移除Executor。
-   给其他Executor提供shuffle数据服务。Spark系统在运行含shuffle过程的应用时，Executor进程除了运行task，还要负责写shuffle数据，给其他Executor提供shuffle数据。当Executor进程任务过重，导致GC而不能为其他Executor提供shuffle数据时，会影响任务运行。External shuffle Service是长期存在于NodeManager进程中的一个辅助服务。通过该服务来抓取shuffle数据，减少了Executor的压力，在Executor GC的时候也不会影响其他Executor的任务运行。我们可以在Executor完成后就移除它，由External shuffle Service给其他Executor继续提供shuffle数据服务。
-   缓存数据。写shuffle文件的时候，Executor也会缓存数据到磁盘或内存中，一旦Executor移除，这部分数据也会不可访问，因此只要有缓存数据，Executor就不会被移除。设置`spark.dynamicAllocation.cachedExecutorIdleTimeout`可在即使有缓存数据的情况下也能在超时的时候移除Executor，该值默认为无线大。后续这个可能会被优化，类似于使用External shuffle Service。

 